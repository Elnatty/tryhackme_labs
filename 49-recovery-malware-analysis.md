# 49 - Recovery (Malware Analysis)

Room Link --> [https://tryhackme.com/room/recovery](https://tryhackme.com/room/recovery)

### Enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
nmap -Pn -n -vv 10.10.152.78 -p- -T5 -sV

PORT      STATE SERVICE REASON  VERSION
22/tcp    open  ssh     syn-ack OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
80/tcp    open  http    syn-ack Apache httpd 2.4.43 ((Unix))
1337/tcp  open  http    syn-ack nginx 1.14.0 (Ubuntu)
65499/tcp open  ssh     syn-ack OpenSSH 7.6p1 Ubuntu 4ubuntu0.3
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
{% endcode %}

Alex said we should visit the website on port 1337 to check our progress.

<figure><img src=".gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Logged in to his ssh acct:

<figure><img src=".gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

It logs us out fter some seconds.

There are 2 ways to get into the PC from here:

1. Login ssh and execute `/bin/sh` , since bash is the terminal affected by the malware. ie;  `ssh alex@<ip> /bin/sh` .
2. Or, we can use `scp` to copy the file from alex pc, to our kali. ie; `scp alex@<ip>:~fixutil .` .

I used the 1st method to get in, then delete the `.bashrc` file, and we get flag 1.

<figure><img src=".gitbook/assets/image (8) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Flag 0

Delete `.bashrc` file.

<figure><img src=".gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

So i ran `strings fixutil` - and saw that this binary file is doing many things.

From the output we saw this file:

<figure><img src=".gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

But i cant access it, but there is another file in `/opt` dir.

{% code overflow="wrap" lineNumbers="true" %}
```bash
$ ls -l /opt/.fixutil/backup.txt
ls: cannot access '/opt/.fixutil/backup.txt': Permission denied

$ cd /opt
$ ls -al
total 16
drwxr-xr-x 1 root root 4096 Jun 17  2020 .
drwxr-xr-x 1 root root 4096 Jun 17  2020 ..
drwx------ 2 root root 4096 Jun 17  2020 .fixutil
-rwxrwxrwx 1 root root   95 Jun 17  2020 brilliant_script.sh
```
{% endcode %}

### Flag 1

The `brilliant_script.sh` file is running as root and we have `rwx` permission on it, so we can modify it an put a rev shell.

<figure><img src=".gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Got root access immediately. And also flag 1.

<figure><img src=".gitbook/assets/image (4) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Flag 3

The malware added the hacker's ssh pub key into the authorized\_keys file owned by the `Root` user for persistence, so he can easily log back in anytime as root. So we have to delete the file or remove his pub key from the `authorized_keys` file.

<figure><img src=".gitbook/assets/image (5) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" lineNumbers="true" %}
```bash
# cd /root
# ls -al
total 24
drwx------ 1 root root 4096 Jun 17  2020 .
drwxr-xr-x 1 root root 4096 Jun 17  2020 ..
-rw-r--r-- 1 root root  570 Jan 31  2010 .bashrc
-rw-r--r-- 1 root root  148 Aug 17  2015 .profile
drwxr-xr-x 1 root root 4096 Jun 17  2020 .ssh
-rwxrwxr-x 1 root root   54 Jun 17  2020 init_script.sh
# cd .ssh
# ls -al
total 12
drwxr-xr-x 1 root root 4096 Jun 17  2020 .
drwx------ 1 root root 4096 Jun 17  2020 ..
-rw-r--r-- 1 root root  567 Jun 17  2020 authorized_keys
# rm authorized_keys
# cd ..
# 
```
{% endcode %}

And we get flag 3.

<figure><img src=".gitbook/assets/image (6) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Remain 2 flags.

### Flag 4

The malware also added a `security` user as root, we have to delete this user.

<figure><img src=".gitbook/assets/image (7) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

```bash
/usr/sbin/userdel -rf security 
```

And we get flag 4

<figure><img src=".gitbook/assets/image (8) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

This cron job that runs every minute that gave us root access, we have to delete it also. SO we are already root, we can change passwd of root, then delete the cron job and the script.

<figure><img src=".gitbook/assets/image (9) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Flag 2

<figure><img src=".gitbook/assets/image (10) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

The malware renamed this file and added `old` we have to rename it back do default.

```bash
mv oldliblogging.so liblogging.so
```

<figure><img src=".gitbook/assets/image (11) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

And we get flag 2

### Flag 5

The final task is to decrypt the encrypted server files.

<figure><img src=".gitbook/assets/image (12) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src=".gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

Let’s take a look at this again:

<figure><img src="https://gameofpwnz.com/wp-content/uploads/2020/08/logging.png" alt="" height="71" width="521"><figcaption></figcaption></figure>

Let’s take a look at the top 3 directories/files.

<figure><img src="https://gameofpwnz.com/wp-content/uploads/2020/08/encrypted.png" alt="" height="314" width="629"><figcaption></figcaption></figure>

Well, it looks like the htdocs were encrypted.

<figure><img src="https://gameofpwnz.com/wp-content/uploads/2020/08/backup.png" alt="" height="134" width="617"><figcaption></figcaption></figure>

And the backup.txt looks like it could be the key. But how do we decrypt?

Well after looking at the fixutil file again, you can see XOR.

<figure><img src="https://gameofpwnz.com/wp-content/uploads/2020/08/xor.png" alt="" height="143" width="136"><figcaption></figcaption></figure>

So, the next step I took was copy over all the files to my local system.

<figure><img src="https://gameofpwnz.com/wp-content/uploads/2020/08/scphtdocs.png" alt="" height="110" width="772"><figcaption></figcaption></figure>

I then used CyberChef to decrypt the files: [https://gchq.github.io/CyberChef/](https://gchq.github.io/CyberChef/)

<figure><img src=".gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

After decrypting them, send them back to the box. And we get flag 5.

<figure><img src=".gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Done!

