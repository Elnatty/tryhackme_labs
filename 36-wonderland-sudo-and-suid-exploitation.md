# 36 - Wonderland (sudo and suid exploitation)

Room Link --> [https://tryhackme.com/room/wonderland](https://tryhackme.com/room/wonderland)

### Enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
sudo nmap -Pn -n -sV -T5 -p- -vv 10.10.76.15

PORT   STATE SERVICE REASON         VERSION
22/tcp open  ssh     syn-ack ttl 63 OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    syn-ack ttl 63 Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
```
{% endcode %}

#### FFUF enum

{% code overflow="wrap" lineNumbers="true" %}
```bash
ffuf -u http://10.10.76.15/FUZZ -c -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -fc 403,400 -t 500

# output
img
r
poem
```
{% endcode %}

#### dirsearch enum

So i visited `r`&#x20;

<figure><img src=".gitbook/assets/image (260).png" alt=""><figcaption></figcaption></figure>

Then i enumerated for `r` with dirsearch:

{% code overflow="wrap" lineNumbers="true" %}
```bash
dirsearch -u http://10.10.76.15/r/a -x 403 -w /usr/share/dirb/wordlists/common.txt -t 200

[06:41:36] 301 -    0B  - /r/a  ->  a/

# i enumerated for /r/a
dirsearch -u http://10.10.76.15/r/a -x 403 -w /usr/share/dirb/wordlists/common.txt -t 200
[06:45:55] 301 -    0B  - /r/a/b  ->  b/
```
{% endcode %}

So it looks like a pattern "rabbit hole", then i contiuned visiting the webpage. I went on and on tilli spelt `rabbit` , when you check the source code, you see a cred, i tried it for ssh and i got in.

`alice : HowDothTheLittleCrocodileImproveHisShiningTail` .

<figure><img src=".gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

<figure><img src=".gitbook/assets/image (262).png" alt=""><figcaption></figcaption></figure>

### Priv Esc Rabbit

`sudo -l`&#x20;

<figure><img src=".gitbook/assets/image (263).png" alt=""><figcaption></figcaption></figure>

We can run the "/home/alice/walrus\_and\_the\_carpenter.py" script as user "rabbit"

So basically the script will print out 10 random lines of the poem.

<figure><img src="https://miro.medium.com/v2/resize:fit:384/1*YwXUY5rCqHue4xkR9GLIgw.png" alt="" height="83" width="559"><figcaption></figcaption></figure>

But what suspicious is that, it imports the **random** library. When we execute the script, it fetches the library needed. These libraries have been stored in predefined locations(directories). And you can use the command below to know those directories.

> python3 -c ‘import sys; print(sys.path)’

<figure><img src="https://miro.medium.com/v2/resize:fit:481/1*BjA5_Vcr5hLIGwkCMUAgYw.png" alt="" height="98" width="700"><figcaption></figcaption></figure>

As you can see, the **‘ ‘** is where the python script will start. It’s our current directory (/home/alice). It will then go through the folders listed above to find “**random.py**” and use it. Now let’s see where is the **random.py.**

> locate random.py

<figure><img src="https://miro.medium.com/v2/resize:fit:481/1*UBJkdztApbrnWAzv1MNYWQ.png" alt="" height="89" width="700"><figcaption><p>locate random.py</p></figcaption></figure>

Now we know that the random.py stays in **/usr/lib/python3.6**, which is **AFTER** alice home folder. Which means that if we create a **random.py** file in alice home folder, the python program will use that **random.py**, not the real random.py in /usr/lib/python3.6.

Let’s create **random.py** but inside, we will spawn a shell!

<figure><img src="https://miro.medium.com/v2/resize:fit:411/1*pMCbQNKniCYbAnBXroWV3w.png" alt="" height="163" width="598"><figcaption></figcaption></figure>

Now save this random.py, **chmod +x** to make it executable and then, run the walrus\_and\_the\_carpenter.py as rabbit.

> sudo -u rabbit /usr/bin/python3.6 /home/alice/walrus\_and\_the\_carpenter.py

<figure><img src="https://miro.medium.com/v2/resize:fit:481/1*A8TMEC8HnKO64x002a7gtw.png" alt="" height="110" width="700"><figcaption></figcaption></figure>

And now I’m rabbit!

### Priv Esc to Hatter

IN the home folder there is a "teaParty" binary, we transfer it to our kali to run `strings` cmd on it.

<figure><img src=".gitbook/assets/image (264).png" alt=""><figcaption></figcaption></figure>

Since the only that the script is doing is running the date command to find out the time and then print the next hour, we need to exploit this. To exploit, we create our version of the date command with shell invocation command and then export the path of our date into the system path so that it executes our date command instead of the original one.

<figure><img src=".gitbook/assets/image (265).png" alt=""><figcaption></figcaption></figure>



IN the Hatter home dir, we find his password, we can ssh into hatter with the password.

<figure><img src=".gitbook/assets/image (266).png" alt=""><figcaption></figcaption></figure>

### Priv Esc to Root

Sudo -l was not allowed for the hatter user, so we ran `linPEAS.sh`&#x20;

Scroll down and I see a line “**Capabilities**”

<figure><img src="https://miro.medium.com/v2/resize:fit:294/1*oEdObreP1b8JJ5g8CMzkFg.png" alt="" height="148" width="428"><figcaption><p>capabilities</p></figcaption></figure>

It’s **perl** command. Look at [https://gtfobins.github.io/gtfobins/perl/#capabilities](https://gtfobins.github.io/gtfobins/perl/#capabilities)

Running this gave me root

```
perl -e 'use POSIX qw(setuid); POSIX::setuid(0); exec "/bin/sh";'
```

<figure><img src=".gitbook/assets/image (267).png" alt=""><figcaption></figcaption></figure>

Done!

